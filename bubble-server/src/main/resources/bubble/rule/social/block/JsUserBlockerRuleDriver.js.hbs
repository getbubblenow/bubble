let {{JS_PREFIX}}_blocked_users = null;
let {{JS_PREFIX}}_blocked_keywords = null;
let {{JS_PREFIX}}_blocked_links = null;
const {{JS_PREFIX}}_request_id = '{{BUBBLE_REQUEST_ID}}';

let {{JS_PREFIX}}_unblocked_users_needs_refresh = false;

let {{JS_PREFIX}}_interval = null;
let {{JS_PREFIX}}_last_applied = null;
const {{JS_PREFIX}}_idle_interval = 2500;

let {{JS_PREFIX}}_messages = null;

function {{JS_PREFIX}}_uuidv4() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0, v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
    });
}

const {{JS_PREFIX}}_create_block_img = function(size) {
    const img = document.createElement('img');
    img.src = '/__bubble/api/filter/assets/{{BUBBLE_REQUEST_ID}}/UserBlocker/icon?raw=true';
    img.width = typeof size !== 'undefined' ? size : 24;
    return img;
}

const {{JS_PREFIX}}_create_unblock_img = function(size) {
    const img = document.createElement('img');
    img.src = '/__bubble/api/filter/assets/{{BUBBLE_REQUEST_ID}}/UserBlocker/unblock-icon?raw=true';
    img.width = typeof size !== 'undefined' ? size : 16;
    return img;
}

const {{JS_PREFIX}}_stop_refreshing_blocks = function(e) {
    if ({{JS_PREFIX}}_interval !== null) {
        window.clearInterval({{JS_PREFIX}}_interval);
        {{JS_PREFIX}}_interval = null;
    }
}
const {{JS_PREFIX}}_refresh_blocks = function(e) {
    {{PAGE_PREFIX}}_log('_refresh_blocks!');
    {{JS_PREFIX}}_last_applied = Date.now();
    {{JS_PREFIX}}_stop_refreshing_blocks();
    {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
    {{JS_PREFIX}}_interval = window.setInterval(function () {
        {{JS_PREFIX}}_last_applied = Date.now();
        {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
    }, {{JS_PREFIX}}_idle_interval);
}

function {{JS_PREFIX}}_fetch_blocks (do_apply) {
    const requestOptions = { method: 'GET' };
    const blocked_users_url = '/__bubble/api/filter/data/{{BUBBLE_DATA_ID}}/read?value=true';
    fetch(blocked_users_url, requestOptions)
        .then(resp => resp.json())
        .then(data => {
            const blocked_users = [];
            const blocked_keywords = [];
            const blocked_links = [];
            for (let i=0; i<data.length; i++) {
                let token = data[i];
                if (token.startsWith('kw:')) {
                    blocked_keywords.push(token);
                } else if (token.startsWith('link:')) {
                    blocked_links.push(token);
                } else {
                    blocked_users.push(token);
                }
            }
            {{JS_PREFIX}}_blocked_users = blocked_users;
            {{JS_PREFIX}}_blocked_keywords = blocked_keywords;
            {{JS_PREFIX}}_blocked_links = blocked_links;
            {{JS_PREFIX}}_refresh_blocks();
        });
}

window.addEventListener('popstate', {{JS_PREFIX}}_refresh_blocks);

function {{JS_PREFIX}}_handleVisibilityChange() {
    if (document.hidden) {
        {{JS_PREFIX}}_stop_refreshing_blocks();
    } else  {
        {{JS_PREFIX}}_refresh_blocks();
    }
}

function {{JS_PREFIX}}_check_stale_refresher(ev) {
    if ({{JS_PREFIX}}_last_applied === null || Date.now() - {{JS_PREFIX}}_last_applied > 2*{{JS_PREFIX}}_idle_interval) {
        {{PAGE_PREFIX}}_log('check_stale_refresher forcing refresh upon document event.type='+ev.type);
        {{JS_PREFIX}}_refresh_blocks();
    }
}

document.addEventListener("visibilitychange", {{JS_PREFIX}}_handleVisibilityChange, false);
document.addEventListener("click", {{JS_PREFIX}}_check_stale_refresher, false);
document.addEventListener("scroll", {{JS_PREFIX}}_check_stale_refresher, false);

function {{JS_PREFIX}}_update_user (author, do_block) {
    {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
    const block_user_url = '/__bubble/api/filter/data/{{BUBBLE_DATA_ID}}/write';
    const requestOptions = {
        method: 'POST',
        body: JSON.stringify({key: author, data: do_block})
    };
    fetch(block_user_url, requestOptions);
}

function {{JS_PREFIX}}_block_user (author) {
    const index = {{JS_PREFIX}}_blocked_users.indexOf(author);
    if (index === -1) {
        {{JS_PREFIX}}_blocked_users.push(author);
        {{JS_PREFIX}}_update_user(author, true);
    }
}

function {{JS_PREFIX}}_unblock_user (author) {
    const index = {{JS_PREFIX}}_blocked_users.indexOf(author);
    if (index === -1) return false;
    {{JS_PREFIX}}_blocked_users.splice(index, 1);
    {{JS_PREFIX}}_update_user(author, false);
    return true;
}

let {{JS_PREFIX}}_app_details = false;

function {{JS_PREFIX}}_create_unblock_control(authorName) {
    const imgHolder = {{JS_PREFIX}}_create_unblock_img();
    const blockSpan = document.createElement('span');
    const unblockLink = document.createElement('a');
    unblockLink.addEventListener("click", function (e) {
        if ({{JS_PREFIX}}_unblock_user(authorName)) {
            {{JS_PREFIX}}_unblocked_users_needs_refresh = true;
            {{JS_PREFIX}}_hide_app_details();
            {{JS_PREFIX}}_show_app_details();
        }
        e.stopPropagation();
        e.preventDefault();
        return false;
    });
    unblockLink.appendChild(imgHolder);
    blockSpan.appendChild(unblockLink)
    blockSpan.id = 'blockSpan_'+{{JS_PREFIX}}_uuidv4();
    return blockSpan;
}

function {{JS_PREFIX}}_hide_app_details() {
    {{PAGE_PREFIX}}_log('hide_app_details called');
    const detailsDivId = '{{JS_PREFIX}}_detailsDiv';
    let detailsDiv = document.getElementById(detailsDivId);
    {{JS_PREFIX}}_app_details = false;
    if (detailsDiv != null) {
        detailsDiv.style.display = 'none';
        while (detailsDiv.firstChild) {
            detailsDiv.removeChild(detailsDiv.lastChild);
        }
    }
}

function {{JS_PREFIX}}_show_app_details() {
    {{PAGE_PREFIX}}_log('show_app_details called');
    {{JS_PREFIX}}_refresh_blocks();
    const detailsDivId = '{{JS_PREFIX}}_detailsDiv';
    let detailsDiv = document.getElementById(detailsDivId);
    let blocks = {{JS_PREFIX}}_blocked_users;
    {{JS_PREFIX}}_app_details = true;
    if (detailsDiv === null) {
        detailsDiv = {{PAGE_PREFIX}}_createDetailsDiv(detailsDivId);
        document.getElementsByTagName('body')[0].appendChild(detailsDiv);
        detailsDiv.onclick = function (ev) {
            {{JS_PREFIX}}_toggle_app_details();
        }
    }
    while (detailsDiv.firstChild) {
        detailsDiv.removeChild(detailsDiv.lastChild);
    }
    detailsDiv.style.display = 'block';
    detailsDiv.style.visibility = 'visible';

    if (blocks !== null && blocks.length > 0) {
        // add rows for blocked users...
        blocks = blocks.slice(); // copy first, then sort case insensitive using user's locale
        blocks.sort(function (a, b) {
            return a.localeCompare(b, '{{ACCOUNT_LANG}}', {'sensitivity': 'base'});
        });
    }
    if ({{JS_PREFIX}}_unblocked_users_needs_refresh) {
        const refreshControl = document.createElement('a');
        refreshControl.style.textDecoration = 'underline';
        refreshControl.style.color = 'blue';
        refreshControl.addEventListener("click", function (e) {
            e.stopPropagation();
            e.preventDefault();
            window.location.reload();
            return false;
        });
        const refreshMessage = {{PAGE_PREFIX}}_msg_or_default({{JS_PREFIX}}_messages, 'web_refreshPage', 'refresh');
        refreshControl.appendChild(document.createTextNode(refreshMessage));
        detailsDiv.appendChild(refreshControl);
        detailsDiv.appendChild(document.createElement('hr'));
    }
    const usersHeaderText = {{PAGE_PREFIX}}_msg_or_default({{JS_PREFIX}}_messages, 'web_blockedUsers', 'Users');
    const usersHeader = document.createElement('strong');
    usersHeader.appendChild(document.createTextNode(usersHeaderText));
    detailsDiv.appendChild(usersHeader);
    detailsDiv.appendChild(document.createElement('hr'));

    if (blocks === null || blocks.length === 0) {
        const emptyMessage = {{PAGE_PREFIX}}_msg_or_default({{JS_PREFIX}}_messages, 'web_noUsersBlocked', '(empty)');
        const entryDiv = document.createElement('div');
        const entryText = document.createTextNode(emptyMessage);
        entryDiv.appendChild(entryText);
        detailsDiv.appendChild(entryDiv);
    } else {
        for (let i = 0; i < blocks.length; i++) {
            const entry = blocks[i];
            const entryDiv = document.createElement('div');
            const entryText = document.createTextNode(entry);
            entryDiv.appendChild(entryText);
            entryDiv.appendChild({{JS_PREFIX}}_create_unblock_control(entry));
            detailsDiv.appendChild(entryDiv);
        }
    }
}

function {{JS_PREFIX}}_toggle_app_details(ev) {
    if ({{JS_PREFIX}}_app_details) {
        {{JS_PREFIX}}_hide_app_details();
    } else {
        {{JS_PREFIX}}_show_app_details();
    }
}

{{{APPLY_BLOCKS_JS}}}

{{{ICON_JS}}}

{{PAGE_PREFIX}}_addBubbleApp({
    jsPrefix: '{{JS_PREFIX}}',
    app: '{{BUBBLE_APP_NAME}}',
    link: {{JS_PREFIX}}_toggle_app_details,
    icon: 'icon',
    onReady: function () {
        {{JS_PREFIX}}_load_messages('web_', function (messages) {
            {{JS_PREFIX}}_messages = messages;
        })
        {{JS_PREFIX}}_fetch_blocks();
    }
});
