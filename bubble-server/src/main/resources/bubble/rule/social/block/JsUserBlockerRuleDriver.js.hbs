let {{JS_PREFIX}}_blocked_users = null;
const {{JS_PREFIX}}_request_id = '{{BUBBLE_REQUEST_ID}}';

let {{JS_PREFIX}}_interval = null;
let {{JS_PREFIX}}_last_applied = null;
const {{JS_PREFIX}}_idle_interval = 2500;

function {{JS_PREFIX}}_fetch_blocks (do_apply) {
    const requestOptions = { method: 'GET' };
    const blocked_users_url = '/__bubble/api/filter/data/{{BUBBLE_DATA_ID}}/read';
    fetch(blocked_users_url, requestOptions)
        .then(resp => resp.json())
        .then(data => {
            const blocked_users = [];
            for (let i=0; i<data.length; i++) {
                blocked_users.push(data[i]);
            }
            {{JS_PREFIX}}_blocked_users = blocked_users;
            {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
            if ({{JS_PREFIX}}_interval === null) {
                {{JS_PREFIX}}_interval = window.setInterval(function () {
                    {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
                    {{JS_PREFIX}}_last_applied = Date.now();
                }, {{JS_PREFIX}}_idle_interval);
            }
        });
}

window.addEventListener('popstate', function(e) {
    if ({{JS_PREFIX}}_interval !== null) {
        window.clearInterval({{JS_PREFIX}}_interval);
    }
    {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
    {{JS_PREFIX}}_interval = window.setInterval(function () {
        {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
        {{JS_PREFIX}}_last_applied = Date.now();
    }, {{JS_PREFIX}}_idle_interval);
});

function {{JS_PREFIX}}_block_user (author) {
    {{JS_PREFIX}}_blocked_users.push(author);
    {{JS_PREFIX}}_apply_blocks({{JS_PREFIX}}_blocked_users);
    const block_user_url = '/__bubble/api/filter/data/{{BUBBLE_DATA_ID}}/write';
    const requestOptions = {
        method: 'POST',
        body: JSON.stringify({key: author, data: true})
    };
    fetch(block_user_url, requestOptions);
}

{{{APPLY_BLOCKS_JS}}}

{{{ICON_JS}}}

{{PAGE_PREFIX}}_addBubbleApp({
    jsPrefix: '{{JS_PREFIX}}',
    app: '{{BUBBLE_APP_NAME}}',
    link: 'site/{{BUBBLE_SITE_NAME}}/view/blocked_users',
    icon: 'icon',
    onReady: function () { {{JS_PREFIX}}_fetch_blocks(); }
});
