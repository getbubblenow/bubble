{{JS_PREFIX}}_load_messages = function (messages, set_func) {
    const requestOptions = { method: 'GET' };
    const find = Array.isArray(messages) ? messages.join(",") : 'prefix:' + messages;
    fetch('/__bubble/api/filter/messages/{{BUBBLE_REQUEST_ID}}/{{BUBBLE_APP_NAME}}/{{ACCOUNT_LOCALE}}/find/'+find, requestOptions)
        .then(response => response.json())
        .then(appMessages => {
            const map = {};
            for (let i=0; i<appMessages.messages.length; i++) {
                const m = appMessages.messages[i];
                map[m.name] = m.value;
            }
            set_func(map);
        })
        .catch((error) => {
            console.error('Error getting messages ('+messages+'): '+error);
        });
}

{{JS_PREFIX}}_link_message_url = function (link) {
    return '/__bubble/api/filter/messages/{{BUBBLE_REQUEST_ID}}/{{BUBBLE_APP_NAME}}/{{ACCOUNT_LOCALE}}/link/'+link+'_url';
}

{{JS_PREFIX}}_asset_img_url = function (icon) {
    return '/__bubble/api/filter/assets/{{BUBBLE_REQUEST_ID}}/{{BUBBLE_APP_NAME}}/'+icon+'?raw=true';
}

{{JS_PREFIX}}_load_link_message = function (link, set_func) {
    const requestOptions = { method: 'GET' };
    fetch({{JS_PREFIX}}_link_message_url(link), requestOptions)
        .then(response => response.text())
        .then(data => set_func(data))
        .catch((error) => {
            console.error('Error getting link message ('+messages+'): '+error);
        });
}

if (typeof {{PAGE_PREFIX}}_icon_status === 'undefined') {
    let {{PAGE_PREFIX}}_doc_ready = false;

    let {{PAGE_PREFIX}}_icon_status = [];

    {{PAGE_PREFIX}}_msg_or_default = function (messages, msg, def) {
        return msg in messages ? messages[msg] : def;
    }

    {{PAGE_PREFIX}}_log = function (data) {
        const logData = JSON.stringify(data);
        const requestOptions = {
            method: 'POST',
            body: logData
        };
        // console.log('Logging to server: '+logData);
        fetch('/__bubble/api/filter/logs/{{BUBBLE_REQUEST_ID}}', requestOptions)
            .then(() => {
                // console.log('Logged to server: '+logData);
            })
            .catch((error) => {
                console.error('Error logging "'+logData+'" to server: '+error);
            });
    }

    {{PAGE_PREFIX}}_createDetailsDiv = function (id) {
        const detailsDiv = document.createElement('div');
        detailsDiv.id = id;
        detailsDiv.style.backgroundColor = '#ffffff';
        detailsDiv.style.position = 'fixed';
        detailsDiv.style.bottom = '10px';
        detailsDiv.style.right = '5px';
        detailsDiv.style.maxHeight = '80%';
        detailsDiv.style.maxWidth = '80%';
        detailsDiv.style.overflowX = 'scroll';
        detailsDiv.style.overflowY = 'scroll';
        detailsDiv.style.border = '1px solid black';
        detailsDiv.style.padding = '6px'
        detailsDiv.style.zIndex = '{{expr APP_CONTROLS_Z_INDEX '+' 1}}';
        return detailsDiv;
    }

    {{PAGE_PREFIX}}_addBubbleApp = function (app) {
        if (window.self === window.top) {
            if ({{PAGE_PREFIX}}_icon_status.find(a => a.app === app.app)) {
                {{PAGE_PREFIX}}_log('addBubbleApp: NOT adding app (already added): '+app.app);
            } else {
                {{PAGE_PREFIX}}_log('addBubbleApp: adding app: '+app.app);
                {{PAGE_PREFIX}}_icon_status.push(app);
            }
        }
    }

    {{PAGE_PREFIX}}_getAppIconImgSrc = function (app) {
        return '/__bubble/api/filter/assets/{{BUBBLE_REQUEST_ID}}/' + app.app + '/' + app.icon + '?raw=true';
    }

    {{PAGE_PREFIX}}_getAppIconImgId = function (app) {
        return app.jsPrefix + '_app_icon_img';
    }

    {{PAGE_PREFIX}}_setAppIconImg = function (app) {
        const imgId = {{PAGE_PREFIX}}_getAppIconImgId(app);
        const img = document.getElementById(imgId);
        if (img) {
            img.src = {{PAGE_PREFIX}}_getAppIconImgSrc(app);
        } else {
            console.warn('setAppIconImg: img element not found: '+imgId)
        }
    }

    function {{PAGE_PREFIX}}_onReady(callback) {
        const intervalId = window.setInterval(function() {
            if (document.getElementsByTagName('body')[0] !== undefined) {
                {{PAGE_PREFIX}}_doc_ready = true;
                window.clearInterval(intervalId);
                callback.call(this);
            }
        }, {{PAGE_ONREADY_INTERVAL}});
    }

    {{PAGE_PREFIX}}_onReady(function() {
        const controlDivId = '{{PAGE_PREFIX}}_controlDiv';
        let bubbleControlDiv = document.getElementById(controlDivId);
        if (bubbleControlDiv === null) {
            bubbleControlDiv = document.createElement('div');
            bubbleControlDiv.id = controlDivId;
            bubbleControlDiv.style.position = 'fixed';
            bubbleControlDiv.style.bottom = '0';
            bubbleControlDiv.style.right = '0';
            bubbleControlDiv.style.zIndex = '{{APP_CONTROLS_Z_INDEX}}';
            document.getElementsByTagName('body')[0].appendChild(bubbleControlDiv);
        }
        for (let i=0; i<{{PAGE_PREFIX}}_icon_status.length; i++) {
            const iconSpecs = {{PAGE_PREFIX}}_icon_status[i];
            let br = document.createElement('br');
            let link = document.createElement('a');
            if (typeof iconSpecs.link === 'function') {
                link.onclick = function (ev) { iconSpecs.link(ev); return false; }
            } else {
                link.href = '{{{BUBBLE_HOME}}}/app/' + iconSpecs.app + '/' + iconSpecs.link;
            }
            let img = document.createElement('img');
            img.id = {{PAGE_PREFIX}}_getAppIconImgId(iconSpecs);
            img.src = {{PAGE_PREFIX}}_getAppIconImgSrc(iconSpecs);
            img.width = 48;
            link.appendChild(img);
            bubbleControlDiv.appendChild(br);
            bubbleControlDiv.appendChild(link);
            if (typeof iconSpecs.onReady === 'function') {
                iconSpecs.onReady();
            }
        }
    });
}